<html>
	<head>
		<title>Login - CVFD Radio Chatter</title>
		<link rel="icon" type="image/png" href="/favicon.png" />
		<meta name="theme-color" content="#000000" />

		<link rel="stylesheet" href="/libs/bootstrap.min.css">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<style>
			.hidden {
				display: none;
			}
		</style>
	</head>
	<body class="container">
		<div id="alert-container"></div>
		<div class="form">
			<h1 class="text-center">Login - CVFD Radio Chatter</h1>
			<div class="input-group mb-3" id="phone-container">
				<span class="input-group-text" for="phone">Phone Number</span>
				<input type="text" class="form-control" id="phone" name="phone" placeholder="Enter phone">
			</div>
			<div class="input-group mb-3 hidden" id="code-container">
				<span class="input-group-text" for="code">Authentication Code</span>
				<input type="text" class="form-control" id="code" name="code" placeholder="Auth code" autocomplete="off">
			</div>
			<div class="input-group mb-3">
				<button type="submit" class="btn btn-primary" id="submit">Submit</button>
			</div>
		</div>

		<script async src="/libs/bootstrap.min.js"></script>
		<script>
			const phoneInput = document.getElementById('phone');
			const codeInput = document.getElementById('code');
			const phoneContainer = document.getElementById('phone-container');
			const codeContainer = document.getElementById('code-container');
			const alertContainer = document.getElementById('alert-container');
			const submitButton = document.getElementById('submit');

			phoneInput.addEventListener('keyup', () => {
				const input = phoneInput.value.replace(/\D/g, '');
				const first = input.substring(0, 3);
				const middle = input.substring(3, 6);
				const last = input.substring(6, 10);

				if (input.length > 5) phoneInput.value = `${first}-${middle}-${last}`;
				else if (input.length > 2) phoneInput.value = `${first}-${middle}`;
				else phoneInput.value = `${first}`;
			});

			let stage = 1;
			function submitHandler() {
				phoneInput.classList.remove('is-invalid');
				codeInput.classList.remove('is-invalid');

				let url = `/api?action=`;
				let body = {};
				if (stage === 1) {
					url += `login`;
					body.phone = phoneInput.value.replace(/\D/g, '');
				} else if (stage === 2) {
					url += `auth`;
					body.code = codeInput.value.replace(/\D/g, '');
				}
				let localStage = stage;

				fetch(url, {
					method: 'POST',
					body: JSON.stringify(body)
				})
					.then(r => r.json())
					.then(data => {
						if (!data.success) {
							console.log(data);
							data.errors.forEach(err => {
								const elem = document.getElementById(err);
								if (elem) elem.classList.add('is-invalid');
							});
							return;
						}

						stage = localStage + 1;
						if (stage === 2) {
							codeContainer.classList.remove('hidden');
						} else if (stage === 3) {
							showAlert('success', 'You are now logged in');
							window.location = '/';
						}
					})
					.catch(e => {
						console.error(e);
						showAlert('danger', 'Something went wrong');
					});
			}
			submitButton.addEventListener('click', submitHandler);
			document.addEventListener('keyup', e => {
				if (e.key === 'Enter') submitHandler();
			});

			function showAlert(type, message) {
				const elem = document.createElement('div');
				elem.classList.add('alert', `alert-${type}`, 'alert-dismissible', 'fade', 'show');
				elem.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
				alertContainer.appendChild(elem);
			}
		</script>
	</body>
</html>
