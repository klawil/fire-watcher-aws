<html>
	<head>
		<title>Register - CVFD Radio Chatter</title>
		<link href="/libs/bootstrap.min.css" rel="stylesheet">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<style>
			.hidden {
				display: none;
			}
		</style>
	</head>
	<body class="text-center">
		<h1>Register For CVFD Pages</h1>
		
		<div class="col-md-6 offset-md-3 col-lg-4 offset-lg-4">
			<h2 class="col mb-3 text-center hidden" id="message"></h2>

			<div class="row mb-3" id="name-row">
				<label for="name" class="col-sm-4 col-form-label">Name</label>
				<div class="col-sm-8">
					<input type="text" class="form-control" id="name">
				</div>
			</div>

			<div class="row mb-3" id="phone-row">
				<label for="phone" class="col-sm-4 col-form-label">Phone Number</label>
				<div class="col-sm-8">
					<input type="text" maxlength="16" class="form-control" id="phone" placeholder="555-555-5555">
				</div>
			</div>

			<div id="captcha-row">
				<div class="row mb-2">
					<img id="captcha-img" src="/captcha">
				</div>
				<div class="row mb-3">
					<label for="captcha" class="col-sm-8 col-form-label">Enter the Captcha</label>
					<div class="col-sm-4">
						<input type="text" class="form-control" id="captcha">
					</div>
				</div>
			</div>

			<div class="row mb-2 hidden" id="code-row">
				<label for="code" class="col-sm-8 col-form-label">Enter the Code Texted To You</label>
				<div class="col-sm-4">
					<input type="text" class="form-control" id="code">
				</div>
			</div>

			<div class="row mb-3" id="submit-row">
				<input type="button" class="col btn btn-success" id="submit" value="Submit" />
			</div>
		</div>

		<script>
			let step = 1;
			const inputsToShowAfterStep = [
				[ 'submit', 'code' ],
				[ 'success' ]
			]

			const inputs = [ ...document.querySelectorAll('input') ]
				.reduce((agg, elem) => ({
					...agg,
					[elem.id]: elem
				}), {});
			console.log(inputs);

			function resetCaptcha() {
				document.getElementById('captcha-img').src = '/captcha';
			}

			function isNumericInput(event) {
				const key = event.keyCode;
				return ((key >= 48 && key <= 57) || // Allow number line
					(key >= 96 && key <= 105) // Allow number pad
				);
			}

			function isModifierKey(event) {
				const key = event.keyCode;
				return (event.shiftKey === true || key === 35 || key === 36) || // Allow Shift, Home, End
					(key === 8 || key === 9 || key === 13 || key === 46) || // Allow Backspace, Tab, Enter, Delete
					(key > 36 && key < 41) || // Allow left, up, right, down
					(
						// Allow Ctrl/Command + A,C,V,X,Z
						(event.ctrlKey === true || event.metaKey === true) &&
						(key === 65 || key === 67 || key === 86 || key === 88 || key === 90)
					)
			};

			function enforceFormat(event) {
				// Input must be of a valid number format or a modifier key, and not longer than ten digits
				if(!isNumericInput(event) && !isModifierKey(event)){
					event.preventDefault();
				}
			};

			function formatToPhone(event) {
				if(isModifierKey(event)) {return;}

				const input = event.target.value.replace(/\D/g,'').substring(0,10); // First ten digits of input only
				const areaCode = input.substring(0,3);
				const middle = input.substring(3,6);
				const last = input.substring(6,10);

				if(input.length > 6){event.target.value = `${areaCode}-${middle}-${last}`;}
				else if(input.length > 3){event.target.value = `${areaCode}-${middle}`;}
				else if(input.length > 0){event.target.value = `${areaCode}`;}
			};

			inputs.phone.addEventListener('keydown', enforceFormat);
			inputs.phone.addEventListener('keyup', formatToPhone);
			const messageDiv = document.getElementById('message');

			function responseFilter(response) {
				if (response.message) {
					messageDiv.innerHTML = response.message;
					messageDiv.classList.remove('hidden');
				} else {
					messageDiv.classList.add('hidden');
				}

				if (!response.success) {
					response.errors.forEach((name) => inputs[name].classList.add('is-invalid'));
					if (step === 1) {
						resetCaptcha();
					}
				} else {
					step++;
					Object.keys(inputs)
						.forEach((name) => {
							let row = document.getElementById(`${name}-row`);
							row.classList.remove('hidden');

							if (inputsToShowAfterStep[step - 2].indexOf(name) === -1) {
								row.classList.add('hidden');
							}
						});
				}
			}

			function handleSubmit(e) {
				if (e.key && e.target === inputs.submit) {
					return;
				}

				// Clear the invalid inputs
				Object.keys(inputs)
					.forEach((name) => inputs[name].classList.remove('is-invalid'));

				if (step === 1) {
					let isValid = true;
					if (inputs.name.value === '') {
						inputs.name.classList.add('is-invalid');
						isValid = false;
					}

					if (inputs.phone.value === '') {
						inputs.phone.classList.add('is-invalid');
						isValid = false;
					}

					if (inputs.captcha.value === '') {
						inputs.captcha.classList.add('is-invalid');
						isValid = false;
					}

					if (!isValid) {
						return;
					}

					let body = {
						step,
						phone: inputs.phone.value,
						captcha: inputs.captcha.value
					};

					fetch('/register', {
						method: 'POST',
						body: JSON.stringify(body)
					})
						.then((r) => r.json())
						.then(responseFilter)
						.catch(console.error);
				} else if (step === 2) {
					let isValid = true;
					if (inputs.code.value === '') {
						inputs.code.classList.add('is-invalid');
						isValid = false;
					}

					if (!isValid) {
						return;
					}

					let body = {
						step,
						name: inputs.name.value,
						phone: inputs.phone.value,
						code: inputs.code.value
					};

					fetch('/register', {
						method: 'POST',
						body: JSON.stringify(body)
					})
						.then((r) => r.json())
						.then(responseFilter)
						.catch(console.error);	
				}

				return false;
			}

			inputs.submit.addEventListener('click', handleSubmit);
			document.addEventListener('keyup', (e) => {
				if (e.key === 'Enter') handleSubmit(e);
			});
		</script>
	</body>
</html>
